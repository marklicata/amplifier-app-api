
services:
  amplifier-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: amplifier-app-api
    ports:
      - "8765:8765"
    environment:
      # Service configuration
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8765
      SERVICE_WORKERS: 4
      LOG_LEVEL: info

      # Authentication Settings
      AUTH_MODE: api_key_jwt
      AUTH_REQUIRED: false
      API_KEY_HEADER: X-API-Key

      # Database
      DATABASE_HOST: amplifier-api-db-dev.postgres.database.azure.com
      DATABASE_USER: amplifierdbtest
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-}
      DATABASE_PORT: 5432
      DATABASE_NAME: postgres
      DATABASE_SSL_MODE: require
      DATABASE_POOL_MIN_SIZE: 5
      DATABASE_POOL_MAX_SIZE: 10
      
      # Config Encryption
      CONFIG_ENCRYPTION_KEY: ${CONFIG_ENCRYPTION_KEY:-change-this-config-encryption-key-in-production}

      # CORS
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:8080

      # API Keys (pass through from host)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}

      # Session storage
      SESSION_STORAGE_PATH: /data/sessions
      MAX_SESSION_AGE_DAYS: 30

      # Rate limiting
      RATE_LIMIT_REQUESTS_PER_MINUTE: 60

      # Telemetry
      TELEMETRY_ENABLED: ${TELEMETRY_ENABLED:-true}
      TELEMETRY_APP_INSIGHTS_CONNECTION_STRING: ${TELEMETRY_APP_INSIGHTS_CONNECTION_STRING:-}
      TELEMETRY_APP_ID: amplifier-app-api
      TELEMETRY_ENVIRONMENT: ${TELEMETRY_ENVIRONMENT:-development}
      TELEMETRY_SAMPLE_RATE: ${TELEMETRY_SAMPLE_RATE:-1.0}
      TELEMETRY_SAMPLE_RATE_ERRORS: 1.0
      TELEMETRY_ENABLE_DEV_LOGGER: ${TELEMETRY_ENABLE_DEV_LOGGER:-true}

    volumes:
      # Persist database and sessions
      - amplifier-data:/data
      
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8765/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  amplifier-data:
    driver: local
