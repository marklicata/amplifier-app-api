
services:
  amplifier-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: amplifier-app-api
    ports:
      - "8765:8765"
    environment:
      # Service configuration
      SERVICE_HOST: 0.0.0.0
      SERVICE_PORT: 8765
      SERVICE_WORKERS: 4
      LOG_LEVEL: info

      # Database
      DATABASE_URL: sqlite+aiosqlite:///data/amplifier.db

      # Security
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30

      # CORS
      ALLOWED_ORIGINS: http://localhost:3000,http://localhost:8080

      # API Keys (pass through from host)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}

      # Session storage
      SESSION_STORAGE_PATH: /data/sessions
      MAX_SESSION_AGE_DAYS: 30

      # Rate limiting
      RATE_LIMIT_REQUESTS_PER_MINUTE: 60

      # Telemetry
      TELEMETRY_ENABLED: ${TELEMETRY_ENABLED:-true}
      TELEMETRY_APP_INSIGHTS_CONNECTION_STRING: ${TELEMETRY_APP_INSIGHTS_CONNECTION_STRING:-}
      TELEMETRY_APP_ID: amplifier-app-api
      TELEMETRY_ENVIRONMENT: ${TELEMETRY_ENVIRONMENT:-development}
      TELEMETRY_SAMPLE_RATE: ${TELEMETRY_SAMPLE_RATE:-1.0}
      TELEMETRY_SAMPLE_RATE_ERRORS: 1.0
      TELEMETRY_ENABLE_DEV_LOGGER: ${TELEMETRY_ENABLE_DEV_LOGGER:-true}

    volumes:
      # Persist database and sessions
      - amplifier-data:/data
      
      # Mount local forks (adjust paths as needed)
      - ../amplifier-core:/app/amplifier-core:ro
      - ../amplifier-foundation:/app/amplifier-foundation:ro

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8765/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  amplifier-data:
    driver: local
